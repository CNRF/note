---
tags:
  - RocketMQ
  - 消息中间件
---
## 为什么要用MQ

MQ（Message Queue）:消息队列是一种<font color=red>先进先出</font>的数据结构(类似于排队买东西)

![image-20210506102834628](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050113689.png)

主要应用以下场景

1. 应用解耦
2. 流量削峰
3. 数据分发
4. **异构系统**：跨语言

### 应用解耦

- **系统的耦合性越高，容错性就越低**。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个系统出现了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。
- **使用消息队列解耦合，系统的耦合性就会降低**。比如物流系统发生故障，需要几分钟才能来修复，在这段时间，物流系统要处理的数据被缓存到消息队列中，用户的下单操作正常完成。当物流系统恢复后，补充处理存在消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。

### 流量削峰

![](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050114180.png)

- **应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮**。有了消息队列可以将大量的请求缓存起来，分散到很长一段时间处理，这样可以大大提高系统的稳定行和用户体验。

- **一般情况下，为了保证系统的稳定性，如果系统负载超过阀值，就会阻止用户请求，这样影响用户体验**，而如果使用消息队列将请求缓存起来，等待系统处理完毕后通知用户请求处理完毕。

- **经济考量目的**：业务系统正常时段的QPS如果是1000,流量最高峰是10000,为了应对流量高峰配置高性能

	服务器显然不划算,这是可以使用消息队列对峰值流量削峰

### 数据分发

通过消息队列可以让数据在多个系统之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消息队列中直接获取数据即可。

![](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050114097.png)

### **异构系统**

MQ只需要提供相关消息数据，无需关心生产者消费者的消息的产生和消费，使系统可以**跨语言**

## MQ的优缺点

### MQ的优点

- 解耦、削峰、数据分发、异构系统（跨语言）

### MQ的缺点

- 系统可用性降低
	- 系统引入的外部依赖越多，系统的稳定性越差。一旦MQ宕机，就会对业务造成影响。
	- 产生问题：<font color=red>**如何保证消息高可用**</font>
- 系统复杂度提高
	- MQ的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。
	- 产生问题：
		- <font color=red>**如何保证消息没有被重复消费？**</font>
		- <font color=red>**怎么处理消息丢失情况？**</font>
		- <font color=red>**怎么保证消息传递的顺序性？**</font>
- 一致性问题
	- A系统处理完业务，通过MQ给B、C、D三个系统发送消息数据，如果B系统、C系统处理成功，D系统处理失败。<font color=red>**如何保证消息数据处理的一致性**</font>

### 各种MQ产品的比较

| **特性**   |                         **ActiveMQ**                         | **RabbitMQ**                                                 | **RocketMQ**             | **kafka**                                                    |
| ---------- | :----------------------------------------------------------: | ------------------------------------------------------------ | ------------------------ | ------------------------------------------------------------ |
| 开发语言   |                             Java                             | erlang                                                       | Java                     | Scala                                                        |
| 单机吞吐量 |                             万级                             | 万级                                                         | 十万级                   | 十万级                                                       |
| 时效性     |                             ms级                             | us级                                                         | ms级                     | ms级以内                                                     |
| 可用性     |                        高（主从结构）                        | 高（主从架构）                                               | 非常高（分布式架构）     | 非常高（分布式架构）                                         |
| 功能特性   | 成熟的产品，在很多公司得到了应用；有较多的文档；各种协议支持比较好 | 基于erlang，所以并发能力很强，性能极其好，延时很低；管理界面较丰富 | MQ功能比较完备，扩展性佳 | 只支持主要的MQ功能，像一些消息查询，消息回溯等功能没有提供，毕竟是为大数据准备的，在大数据领域应用广泛 |

