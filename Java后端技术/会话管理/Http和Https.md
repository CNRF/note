---
title: HTTP和HTTPS
date: 2021-05-17 15:22:00
tags: [会话管理]
categories:
- [会话管理]
description: HTTP和HTTPS
updated: 
top: 
hidden: false
---

## HTTP 的最大弊端——不安全

HTTP 之所以被 HTTPS 取代，最大的原因就是不安全，至于为什么不安全，看了下面这张图就一目了然了。

![HTTP数据传输过程](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050021471.png)<font color=red>HTTP 在传输数据的过程中，所有的数据都是明文传输，自然没有安全性可言</font>，特别是一些敏感数据，比如用户密码和信用卡信息等，一旦被第三方获取，后果不堪设想。

如果在前端页面对敏感数据进行加密不就行了，比如 MD5 加盐加密。首先 MD5 并不是加密算法，其全称是 Message Digest Algorithm MD5，意为信息摘要算法，是一种不可逆的哈希算法，也就是说**经过前端 MD5 处理过的数据在服务器端是无法复原的**。这里以密码举例，前端把用户密码通过 MD5 进行处理，并把得到的哈希值发送给服务器，服务器由于无法复原密码，就会直接用这个哈希值处理用户请求。所以**第三方在获取这个哈希值后，可以绕过前端登录页面直接访问服务器，造成安全问题。另外，MD5 算法本身的安全性也存在缺陷**

>  MD5，SHA-1 之类的哈希算法并不能让 HTTP 变得更安全。要想让 HTTP 更安全，只能使用真正的加密算法，因为加密算法可以用密钥加密或还原数据，只要确保密钥不被第三方获取，那就能确保数据传输的安全了。而这正是 HTTPS 的解决方案

## 加密算法

HTTPS 解决数据传输安全问题的方案就是使用加密算法，具体来说是混合加密算法，也就是对称加密和非对称加密的混合使用，这里有必要先了解一下这两种加密算法的区别和优缺点。

### 对称加密

对称加密，顾名思义就是加密和解密都是使用同一个密钥，常见的对称加密算法有 DES、3DES 和 AES 等，其优缺点如下：

#### 优点

算法公开、计算量小、加密速度快、加密效率高，适合加密比较大的数据。

#### 缺点

1. 交易双方需要使用相同的密钥，也就无法避免密钥的传输，而密钥在传输过程中无法保证不被截获，因此对称加密的安全性得不到保证。
2. 每对用户每次使用对称加密算法时，都需要使用其他人不知道的惟一密钥，这会使得发收信双方所拥有的钥匙数量急剧增长，[密钥管理](http://baike.baidu.com/view/297229.htm)成为双方的负担。**对称加密算法在分布式网络系统上使用较为困难，主要是因为密钥管理困难，使用成本较高。**

![对称加密数据传输过程](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050021046.png)

被加密的数据在传输过程中是无规则的乱码，即便被第三方截获，在没有密钥的情况下也无法解密数据，也就保证了数据的安全。

产生了新致命的问题，那就是既然双方要使用相同的密钥，那就必然要在传输数据之前先由一方把密钥传给另一方，那么在此过程中密钥就很有可能被截获，这样一来加密的数据也会被轻松解密。那如何确保密钥在传输过程中的安全呢？这就要用到非对称加密了。

### 非对称加密

非对称加密，顾名思义，就是加密和解密需要使用两个不同的密钥：公钥（public key）和私钥（private key）。公钥与私钥是一对，如果用公钥对数据进行加密，只有用对应的私钥才能解密；如果用私钥对数据进行加密，那么只有用对应的公钥才能解密。

#### 详细过程

<font color=red>甲方生成一对密钥并将其中的一把作为公钥对外公开；得到该公钥的乙方使用公钥对机密信息进行加密后再发送给甲方；甲方再用自己保存的私钥对加密后的信息进行解密。</font>如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。**常用的非对称加密算法是 RSA 算法**

#### 优点

算法公开，加密和解密使用不同的钥匙，私钥不需要通过网络进行传输，安全性很高。

#### 缺点

计算量比较大，加密和解密速度相比对称加密慢很多。

![客户端通过非对称加密把密钥 KEY 发送给服务器](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050021936.png)

客户端在拿到服务器的公钥后，会生成一个随机码 (用 KEY 表示，这个 KEY 就是后续双方用于对称加密的密钥)，然后客户端使用公钥把 KEY 加密后再发送给服务器，服务器使用私钥将其解密，这样双方就有了同一个密钥 KEY，然后双方再使用 KEY 进行对称加密交互数据。在非对称加密传输 KEY 的过程中，即便第三方获取了公钥和加密后的 KEY，在没有私钥的情况下也无法破解 KEY (私钥存在服务器，泄露风险极小)，也就保证了接下来对称加密的数据安全。而上面这个流程图正是 HTTPS 的雏形，HTTPS 正好综合了这两种加密算法的优点，不仅保证了通信安全，还保证了数据传输效率。

## HTTPS 原理详解

**维基百科对 HTTPS 的定义**：HTTPS (Hypertext Transfer Protocol Secure) 是基于 HTTP 的扩展，用于计算机网络的安全通信，已经在互联网得到广泛应用。在 HTTPS 中，原有的 HTTP 协议会得到 TLS (安全传输层协议) 或其前辈 SSL (安全套接层) 的加密。因此 HTTPS 也常指 HTTP over TLS 或 HTTP over SSL。

HTTPS 并非独立的通信协议，而是对 HTTP 的扩展，保证了通信安全，二者关系如下

![HTTP和HTTPS的关系](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050021919.png)

> HTTPS = HTTP + SSL / TLS

![ HTTPS 加密、解密、验证及数据传输过程](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050021136.png)

HTTPS 的整个通信过程可以分为两大阶段：证书验证和数据传输阶段，数据传输阶段又可以分为非对称加密和对称加密两个阶段

1. **客户端请求 HTTPS 网址，然后连接到 server 的 443 端口 (HTTPS 默认端口，类似于 HTTP 的80端口)。**

2. **采用 HTTPS 协议的服务器必须要有一套数字 CA (Certification Authority)证书，证书是需要申请的，并由专门的数字证书认证机构(CA)通过非常严格的审核之后颁发的电子证书 (当然了是要钱的，安全级别越高价格越贵)。颁发证书的同时会产生一个私钥和公钥。私钥由服务端自己保存，不可泄漏。公钥则是附带在证书的信息中，可以公开的。证书本身也附带一个证书电子签名，这个签名用来验证证书的完整性和真实性，可以防止证书被篡改。**

3. **服务器响应客户端请求，将证书传递给客户端，证书包含公钥和大量其他信息**，比如证书颁发机构信息，公司信息和证书有效期等。Chrome 浏览器点击地址栏的锁标志再点击证书就可以看到证书详细信息。

4. **客户端解析证书并对其进行验证**。如果证书不是可信机构颁布，或者证书中的域名与实际域名不一致，或者证书已经过期，就会向访问者显示一个警告。**如果证书没有问题，客户端就会从服务器证书中取出服务器的公钥A。然后客户端还会生成一个随机码 KEY，并使用公钥A将其加密。**

5. **客户端把加密后的随机码 KEY 发送给服务器，作为后面对称加密的密钥。**

6. **服务器在收到随机码 KEY 之后会使用私钥B将其解密。经过以上这些步骤，客户端和服务器终于建立了安全连接，完美解决了对称加密的密钥泄露问题**

7. **服务器使用密钥 (随机码 KEY)对数据进行对称加密并发送给客户端，客户端使用相同的密钥 (随机码 KEY)解密数据**

8. **双方使用对称加密传输所有数据。**

### HTTPS 的缺点

- 在相同网络环境中，HTTPS 相比 HTTP 无论是响应时间还是耗电量都有大幅度上升。
- HTTPS 的安全是有范围的，在黑客攻击、服务器劫持等情况下几乎起不到作用。
- 在现有的证书机制下，[中间人攻击](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)依然有可能发生。
- HTTPS 需要更多的服务器资源，也会导致成本的升高。

## SSL / TLS 工作原理和详细握手过程

### SSL / TLS 以及 SSL / TLS 握手的概念

**SSL 和 TLS 协议可以为通信双方提供识别和认证通道，从而保证通信的机密性和数据完整性**。TLS 协议是从Netscape SSL 3.0协议演变而来的，不过这两种协议并不兼容，SSL 已经逐渐被 TLS 取代，所以下文就以 TLS 指代安全层。 TLS 握手是启动 HTTPS 通信的过程，类似于 TCP 建立连接时的三次握手。 在 TLS 握手的过程中，通信双方交换消息以相互验证，相互确认，并确立它们所要使用的加密算法以及会话密钥 (用于对称加密的密钥)。可以说，TLS 握手是 HTTPS 通信的基础部分。

### TLS 握手过程中发生了什么

- 商定双方通信所使用的的 TLS 版本 (例如 TLS1.0, 1.2, 1.3等等)；
- 确定双方所要使用的密码组合；
- 客户端通过服务器的公钥和数字证书 上的数字签名验证服务端的身份；
- 生成会话密钥，该密钥将用于握手结束后的对称加密。

### TLS 握手详细过程

![SSL / TLS 握手详细过程](https://raw.githubusercontent.com/CNRF/noteImage/main/image/202302050021363.png)

1. **"client hello"消息：**客户端通过发送"client hello"消息向服务器发起握手请求，该消息包含了客户端所支持的 TLS 版本和密码组合以供服务器进行选择，还有一个"client random"随机字符串。

2. **"server hello"消息：**服务器发送"server hello"消息对客户端进行回应，该消息包含了数字证书，服务器选择的密码组合和"server random"随机字符串。

3. **验证：**客户端对服务器发来的证书进行验证，确保对方的合法身份，验证过程可以细化为以下几个步骤：

	1. 检查数字签名
	2. 验证证书链 (这个概念下面会进行说明)
	3. 检查证书的有效期
	4. 检查证书的撤回状态 (撤回代表证书已失效)

4. **"premaster secret"字符串：**客户端向服务器发送另一个随机字符串"premaster secret (预主密钥)"，这个字符串是经过服务器的公钥加密过的，只有对应的私钥才能解密。

5. **使用私钥：**服务器使用私钥解密"premaster secret"。

6. **生成共享密钥**：客户端和服务器均使用 client random，server random 和 premaster secret，并通过相同的算法生成相同的共享密钥 **KEY**。

7. **客户端就绪：**客户端发送经过共享密钥 **KEY**加密过的"finished"信号。

8. **服务器就绪：**服务器发送经过共享密钥 **KEY**加密过的"finished"信号。

9. **达成安全通信：**握手完成，双方使用对称加密进行安全通信。

	> 1. 握手期间所使用的的密钥交换和认证算法 (最常用的是 RSA 算法)
	> 2. 加密算法 (用于握手完成后的对称加密，常用的有 AES、3DES等)
	> 3. 信息摘要算法 (常用的有 SHA-256、SHA-1 和 MD5 等)

## HTTPS 和 HTTP 的区别

- 最最重要的区别就是安全性，HTTP 明文传输，不对数据进行加密安全性较差。HTTPS (HTTP + SSL / TLS)的数据传输过程是加密的，安全性较好。

- 使用 HTTPS 协议需要申请 CA 证书，一般免费证书较少，因而需要一定费用。证书颁发机构如：Symantec、Comodo、DigiCert 和 GlobalSign 等。

- HTTP 页面响应速度比 HTTPS 快，这个很好理解，由于加了一层安全层，建立连接的过程更复杂，也要交换更多的数据，难免影响速度。

- 由于 HTTPS 是建构在 SSL / TLS 之上的 HTTP 协议，所以，要比 HTTP 更耗费服务器资源。

- HTTPS 和 HTTP 使用的是完全不同的连接方

- 式，用的端口也不一样，前者是 443，后者是 80。

	

## 原文地址: 

 [HTTPS 详解一：附带最精美详尽的 HTTPS 原理图](https://segmentfault.com/a/1190000021494676)

[HTTPS详解二：SSL / TLS 工作原理和详细握手过程](https://segmentfault.com/a/1190000021559557)

